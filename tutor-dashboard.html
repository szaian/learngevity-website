<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tutor Dashboard — Month View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- FullCalendar (month view only) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

  <style>
    /* --- keep page consistent with your site --- */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background:#f7f7f7; }
    nav { background:#fff; padding:10px 0; border-bottom:1px solid #ddd; display:flex; justify-content:center; }
    nav ul { list-style:none; margin:0; padding:0; display:flex; gap:20px; }
    nav a { text-decoration:none; color:#333; font-weight:600; }
    nav a.active { color:#8B0000; }

    .page { max-width:1100px; margin:24px auto; padding:12px; }
    h1 { margin:8px 0 18px; text-align:left; }

    #calendar { background:white; border-radius:8px; padding:12px; box-shadow: 0 4px 14px rgba(0,0,0,0.06); }

    /* Details modal (simple centered modal) */
    .modal-backdrop { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index:50; }
    .modal { width: 92%; max-width: 580px; background:white; border-radius:8px; padding:18px; box-shadow:0 6px 30px rgba(0,0,0,0.2); }
    .modal h2 { margin-top:0; }
    .modal p { margin:6px 0; color:#333; }
    .modal .row { display:flex; gap:12px; margin-top:8px; flex-wrap:wrap; }
    .btn { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
    .btn-primary { background:#2f7d2f; color:#fff; }
    .btn-warning { background:#f39c12; color:#fff; }
    .btn-danger { background:#d9534f; color:#fff; }
    .btn-neutral { background:#6c757d; color:#fff; }

    .close-x { float:right; cursor:pointer; font-weight:bold; color:#666; }

    /* small responsive */
    @media (max-width:600px) {
      .modal { width: 96%; padding:12px; }
    }
  </style>
</head>
<body>

  <!-- NAVIGATION -->
  <nav>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="pricing.html">Pricing</a></li>
      <li><a href="tutors.html">Tutors</a></li>
      <li><a href="apply.html">APPLY</a></li>
      <li><a href="contact.html">Contact Us</a></li>
      <li><a href="tutor-login.html" class="active">Tutor Login</a></li>
    </ul>
  </nav>

  <div class="page">
    <h1 id="welcome">Tutor Dashboard</h1>
    <div id="calendar"></div>
  </div>

  <!-- Modal for event details & status update -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-hidden="true">
    <div class="modal" role="document">
      <span id="closeModal" class="close-x">✕</span>
      <h2 id="evTitle">Session</h2>

      <p><strong>Student:</strong> <span id="evStudent"></span></p>
      <p><strong>Subject:</strong> <span id="evSubject"></span></p>
      <p><strong>Time:</strong> <span id="evTime"></span></p>
      <p><strong>Lesson type:</strong> <span id="evLessonType"></span></p>
      <p><strong>Service type:</strong> <span id="evServiceType"></span></p>
      <p><strong>Rate:</strong> R <span id="evRate"></span></p>
      <p><strong>Location:</strong> <span id="evLocation"></span></p>
      <p><strong>Status:</strong> <span id="evStatus"></span></p>

      <div class="row" style="margin-top:14px;">
        <button id="btnCompleted" class="btn btn-primary">Completed</button>
        <button id="btnMissed" class="btn btn-warning">Missed</button>
        <button id="btnRescheduled" class="btn btn-neutral">Rescheduled</button>
        <button id="btnCancelled" class="btn btn-danger">Cancelled</button>
      </div>
    </div>
  </div>

  <script>
    // Ensure tutor is logged in
    const tutorUsername = localStorage.getItem('tutor_username') || localStorage.getItem('tutorUsername'); // support both keys
    const tutorName = localStorage.getItem('tutorName') || tutorUsername || 'Tutor';
    if (!tutorUsername) {
      alert('Please log in first.');
      window.location.href = '/tutor-login.html';
    } else {
      document.getElementById('welcome').textContent = `Welcome, ${tutorName}`;
    }

    // Utility helpers
    function fmtDateTimeRange(startStr, endStr) {
      const s = new Date(startStr);
      const e = new Date(endStr);
      return `${s.toLocaleDateString()} • ${s.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${e.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
    }

    // Fetch events from server API
    async function fetchEvents() {
      const res = await fetch(`/api/tutor/getSessions?tutor=${encodeURIComponent(tutorUsername)}`);
      if (!res.ok) {
        console.error('Failed to load events', res.statusText);
        return [];
      }
      const j = await res.json();
      if (!j.success) return [];
      return j.events || [];
    }

    // Render FullCalendar (month view)
    let calendar;
    document.addEventListener('DOMContentLoaded', async () => {
      const events = await fetchEvents();

      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: ''
        },
        events,
        eventDisplay: 'block',
        height: 'auto',
        eventColor: '#4CAF50',
        eventTextColor: '#fff',
        eventClick: function(info) {
          openModalForEvent(info.event);
        }
      });

      calendar.render();
    });

    // Modal control
    const modal = document.getElementById('modalBackdrop');
    const closeModal = document.getElementById('closeModal');

    function openModalForEvent(ev) {
      const props = ev.extendedProps || {};
      document.getElementById('evTitle').textContent = props.subject || ev.title || 'Session';
      document.getElementById('evStudent').textContent = props.student_name || 'N/A';
      document.getElementById('evSubject').textContent = props.subject || 'N/A';
      document.getElementById('evTime').textContent = fmtDateTimeRange(ev.start, ev.end);
      document.getElementById('evLessonType').textContent = props.lesson_type || 'N/A';
      document.getElementById('evServiceType').textContent = props.service_type || 'N/A';
      document.getElementById('evRate').textContent = props.rate ?? 'N/A';
      document.getElementById('evLocation').textContent = props.location || 'N/A';
      document.getElementById('evStatus').textContent = props.status || 'Upcoming';

      // store selected event globally
      window.__selectedEvent = ev;

      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeModalFunc() {
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
      window.__selectedEvent = null;
    }
    closeModal.addEventListener('click', closeModalFunc);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModalFunc(); });

    // Update status (calls API)
    async function updateStatus(newStatus) {
      const ev = window.__selectedEvent;
      if (!ev) return alert('No event selected');
      const payload = { sessionId: ev.id, status: newStatus };

      const res = await fetch('/api/tutor/updateSessionStatus', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      const j = await res.json();
      if (!j.success) {
        alert('Failed to update. Please try again.');
        console.error(j);
        return;
      }

      // Update local UI: change event status + color
      ev.setExtendedProp('status', newStatus);
      if (newStatus === 'Completed' || newStatus === 'completed') {
        ev.setProp('backgroundColor', '#7ed957');
      } else if (newStatus === 'Missed' || newStatus === 'missed') {
        ev.setProp('backgroundColor', '#d9534f');
      } else if (newStatus === 'Cancelled' || newStatus === 'cancelled') {
        ev.setProp('backgroundColor', '#6c757d');
      } else if (newStatus === 'Rescheduled' || newStatus === 'rescheduled') {
        ev.setProp('backgroundColor', '#f39c12');
      } else {
        ev.setProp('backgroundColor', '#4CAF50');
      }

      document.getElementById('evStatus').textContent = newStatus;
      // refresh entire events from server for authoritative data
      const refreshed = await fetchEvents();
      calendar.removeAllEvents();
      calendar.addEventSource(refreshed);
      closeModalFunc();
    }

    document.getElementById('btnCompleted').addEventListener('click', ()=> updateStatus('Completed'));
    document.getElementById('btnMissed').addEventListener('click', ()=> updateStatus('Missed'));
    document.getElementById('btnRescheduled').addEventListener('click', ()=> updateStatus('Rescheduled'));
    document.getElementById('btnCancelled').addEventListener('click', ()=> updateStatus('Cancelled'));

  </script>
</body>
</html>
